<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro Max</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { words: [], streak: 0, lastDate: null };
        let activeTest = [];

        const baseWords = [
            {en: 'Apple', ru: '–Ø–±–ª–æ–∫–æ', folder: '–ë–∞–∑–æ–≤—ã–µ'}, {en: 'Dog', ru: '–°–æ–±–∞–∫–∞', folder: '–ë–∞–∑–æ–≤—ã–µ'},
            {en: 'House', ru: '–î–æ–º', folder: '–ë–∞–∑–æ–≤—ã–µ'}, {en: 'Water', ru: '–í–æ–¥–∞', folder: '–ë–∞–∑–æ–≤—ã–µ'},
            {en: 'Family', ru: '–°–µ–º—å—è', folder: '–ë–∞–∑–æ–≤—ã–µ'}, {en: 'Friend', ru: '–î—Ä—É–≥', folder: '–ë–∞–∑–æ–≤—ã–µ'},
            {en: 'Time', ru: '–í—Ä–µ–º—è', folder: '–ë–∞–∑–æ–≤—ã–µ'}, {en: 'Work', ru: '–†–∞–±–æ—Ç–∞', folder: '–ë–∞–∑–æ–≤—ã–µ'},
            {en: 'School', ru: '–®–∫–æ–ª–∞', folder: '–ë–∞–∑–æ–≤—ã–µ'}, {en: 'Book', ru: '–ö–Ω–∏–≥–∞', folder: '–ë–∞–∑–æ–≤—ã–µ'}
        ];

        window.speak = (t) => {
            window.speechSynthesis.cancel();
            let m = new SpeechSynthesisUtterance(t);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        };

        window.login = () => {
            const p = new GoogleAuthProvider();
            p.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, p);
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await syncData();
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                updateStreakUI();
                renderFolderSelects();
                changeTab('cardTab');
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function syncData() {
            const d = await getDoc(doc(db, "users", currentUser.uid));
            if (d.exists()) {
                userData = d.data();
                checkStreak();
            } else {
                userData = { words: baseWords, streak: 0, lastDate: new Date().toDateString() };
                await setDoc(doc(db, "users", currentUser.uid), userData);
            }
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const last = userData.lastDate;
            if (last) {
                const diff = (new Date(today) - new Date(last)) / (1000 * 60 * 60 * 24);
                if (diff > 1) userData.streak = 0;
            }
        }

        async function completeAction() {
            const today = new Date().toDateString();
            if (userData.lastDate !== today) {
                userData.streak++;
                userData.lastDate = today;
                await updateDoc(doc(db, "users", currentUser.uid), userData);
                updateStreakUI();
            }
        }

        function updateStreakUI() {
            document.getElementById('streakVal').innerText = `üî• –°–µ—Ä–∏—è: ${userData.streak}`;
        }

        window.changeTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'cardTab') nextCard();
        };

        function renderFolderSelects() {
            const folders = [...new Set(userData.words.map(w => w.folder))];
            const html = folders.map(f => `<option value="${f}">${f}</option>`).join('');
            document.getElementById('cardFolder').innerHTML = '<option value="all">–í—Å–µ –ø–∞–ø–∫–∏</option>' + html;
            document.getElementById('testFolder').innerHTML = '<option value="all">–í—Å–µ –ø–∞–ø–∫–∏</option>' + html;
        }

        // --- –ö–ê–†–¢–û–ß–ö–ò ---
        window.nextCard = () => {
            const f = document.getElementById('cardFolder').value;
            let pool = f === 'all' ? userData.words : userData.words.filter(w => w.folder === f);
            if(!pool.length) return document.getElementById('cardDisplay').innerText = "–ü—É—Å—Ç–æ!";
            const word = pool[Math.floor(Math.random()*pool.length)];
            const card = document.getElementById('cardDisplay');
            card.innerHTML = `<div class="card-inner" onclick="this.classList.toggle('flipped'); speak('${word.en}')">
                <div class="card-front">${word.ru}</div>
                <div class="card-back">${word.en}</div>
            </div>`;
        };

        // --- –¢–ï–°–¢ ---
        window.startTest = () => {
            const limit = parseInt(document.getElementById('testLimit').value) || 5;
            const folder = document.getElementById('testFolder').value;
            const types = Array.from(document.querySelectorAll('.type-check:checked')).map(c => c.value);
            
            if(!types.length) return alert("–í—ã–±–µ—Ä–∏ —Ç–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π!");
            let pool = folder === 'all' ? userData.words : userData.words.filter(w => w.folder === folder);
            
            activeTest = [...pool].sort(() => 0.5 - Math.random()).slice(0, limit).map(w => {
                const t = types[Math.floor(Math.random() * types.length)];
                let d = { word: w, type: t, userAns: '' };
                if(t === 'choice') {
                    d.opts = [w.en, ...userData.words.filter(x => x.en !== w.en).sort(()=>0.5-Math.random()).slice(0,3).map(x=>x.en)].sort(()=>0.5-Math.random());
                } else if(t === 'tf') {
                    d.isCorrect = Math.random() > 0.5;
                    d.fake = d.isCorrect ? w.en : userData.words[Math.floor(Math.random()*userData.words.length)].en;
                } else if(t === 'letters') {
                    d.scrambled = w.en.split('').sort(()=>0.5-Math.random()).join(' ');
                }
                return d;
            });
            renderTest();
            document.getElementById('testSetup').style.display = 'none';
            document.getElementById('testList').style.display = 'block';
        };

        function renderTest(results = false) {
            document.getElementById('questions').innerHTML = activeTest.map((item, i) => {
                const corr = checkItem(item);
                let h = `<div class="test-window ${results ? (corr ? 'c-win' : 'w-win') : ''}">`;
                if(item.type === 'choice') h += `<p>${item.word.ru} - —ç—Ç–æ...</p><div class="grid">${item.opts.map(o => `<button class="btn-opt ${item.userAns===o?'sel':''}" onclick="setAns(${i},'${o}')">${o}</button>`).join('')}</div>`;
                else if(item.type === 'tf') h += `<p>${item.word.ru} = ${item.fake}?</p><div class="grid" style="grid-template-columns:1fr 1fr"><button class="btn-opt ${item.userAns==='true'?'sel':''}" onclick="setAns(${i},'true')">–î–∞</button><button class="btn-opt ${item.userAns==='false'?'sel':''}" onclick="setAns(${i},'false')">–ù–µ—Ç</button></div>`;
                else if(item.type === 'letters') h += `<p>${item.word.ru}: <span class="hint">${item.scrambled}</span></p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${item.userAns}">`;
                else if(item.type === 'write') h += `<p>–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–≤–æ–¥ "${item.word.ru}":</p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${item.userAns}">`;
                if(results && !corr) { h += `<div class="err-hint">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${item.word.en}</div>`; speak(item.word.en); }
                return h + `</div>`;
            }).join('');
        }

        window.setAns = (i, v) => { activeTest[i].userAns = v; if(['choice','tf'].includes(activeTest[i].type)) renderTest(); };
        function checkItem(it) {
            if(it.type === 'tf') return it.userAns === (it.fake === it.word.en).toString();
            return it.userAns.toLowerCase().trim() === it.word.en.toLowerCase().trim();
        }

        window.finishTest = async () => { 
            renderTest(true); 
            document.getElementById('finishBtn').style.display='none'; 
            document.getElementById('resetBtn').style.display='block';
            await completeAction();
        };

        window.addWords = async () => {
            const txt = document.getElementById('bulkText').value;
            const fold = document.getElementById('newFolder').value || '–û–±—â–∏–µ';
            txt.split('\n').forEach(l => {
                const p = l.split(';');
                if(p.length === 2) userData.words.push({en: p[0].trim(), ru: p[1].trim(), folder: fold});
            });
            await updateDoc(doc(db, "users", currentUser.uid), {words: userData.words});
            alert("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
            renderFolderSelects();
        };
    </script>
    <style>
        :root { --bg: #121225; --card: #ffffff; --primary: #3498db; --accent: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .streak { font-weight: bold; color: #f1c40f; margin: 10px 0; font-size: 20px; }
        .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 500px; margin-bottom: 15px; }
        .menu button { padding: 15px; border: none; background: var(--primary); color: white; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .section { width: 100%; max-width: 500px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ Memory Card */
        .card-box { height: 250px; perspective: 1000px; margin-bottom: 20px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; border-radius: 25px; color: #333; background: var(--card); box-shadow: 0 10px 20px rgba(0,0,0,0.3); padding: 20px; text-align: center; }
        .card-back { transform: rotateY(180deg); color: var(--primary); }

        .test-window { background: white; color: #333; padding: 20px; border-radius: 20px; margin-bottom: 15px; }
        .c-win { border-left: 8px solid var(--accent); }
        .w-win { border-left: 8px solid #e74c3c; }
        .grid { display: grid; gap: 10px; margin-top: 10px; }
        .btn-opt { padding: 12px; border: 2px solid #eee; border-radius: 12px; background: #f9f9f9; cursor: pointer; font-weight: bold; }
        .btn-opt.sel { background: var(--primary); color: white; }
        .inp { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #ddd; font-size: 16px; box-sizing: border-box; }
        .hint { color: var(--primary); letter-spacing: 2px; font-weight: bold; display: block; margin: 5px 0; }
        .err-hint { color: #e74c3c; font-weight: bold; margin-top: 10px; }
        
        .type-select { background: #1e1e3d; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .btn-action { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .exit-btn { position: fixed; bottom: 15px; right: 15px; background: #c0392b; color: white; border: none; padding: 12px 18px; border-radius: 12px; font-weight: bold; z-index: 100; }
        select { width: 100%; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        textarea { width: 100%; height: 120px; border-radius: 15px; padding: 10px; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="authSection" style="margin-top: 100px; text-align: center;">
        <h1 style="font-size: 40px;">üöÄ English Pro</h1>
        <button class="btn-action" style="width:auto; padding: 20px 40px;" onclick="login()">–í–û–ô–¢–ò –° GOOGLE</button>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="streak" id="streakVal">üî• –°–µ—Ä–∏—è: 0</div>
        <div class="menu">
            <button onclick="changeTab('cardTab')">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</button>
            <button onclick="changeTab('testTab')">–¢–µ—Å—Ç—ã</button>
            <button onclick="changeTab('addTab')">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–û–ø—Ü–∏–∏</button>
        </div>

        <div id="cardTab" class="section">
            <select id="cardFolder" onchange="nextCard()"></select>
            <div class="card-box" id="cardDisplay"></div>
            <button class="btn-action" style="background:#7f8c8d" onclick="nextCard()">–î–ê–õ–¨–®–ï ‚Üí</button>
        </div>

        <div id="testTab" class="section" style="display:none">
            <div id="testSetup">
                <div class="type-select">
                    <p style="margin-top:0">–í—ã–±–µ—Ä–∏ –ø–∞–ø–∫–∏ –∏ –∑–∞–¥–∞–Ω–∏—è:</p>
                    <select id="testFolder"></select>
                    <input type="number" id="testLimit" value="5" class="inp" placeholder="–°–∫–æ–ª—å–∫–æ —Å–ª–æ–≤?">
                    <div style="margin-top:10px">
                        <label><input type="checkbox" class="type-check" value="choice" checked> –í—ã–±–æ—Ä</label><br>
                        <label><input type="checkbox" class="type-check" value="tf" checked> True/False</label><br>
                        <label><input type="checkbox" class="type-check" value="letters" checked> –°–±–æ—Ä–∫–∞</label><br>
                        <label><input type="checkbox" class="type-check" value="write" checked> –ü–∏—Å—å–º–æ</label>
                    </div>
                </div>
                <button class="btn-action" onclick="startTest()">–ù–ê–ß–ê–¢–¨ –¢–ï–°–¢</button>
            </div>
            <div id="testList" style="display:none">
                <div id="questions"></div>
                <button id="finishBtn" class="btn-action" onclick="finishTest()">–ó–ê–ö–û–ù–ß–ò–¢–¨</button>
                <button id="resetBtn" class="btn-action" style="display:none; background:var(--primary)" onclick="changeTab('testTab')">–ù–û–í–´–ô –¢–ï–°–¢</button>
            </div>
        </div>

        <div id="addTab" class="section" style="display:none">
            <div class="test-window">
                <input type="text" id="newFolder" class="inp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ (—Ç–µ–º–∞)">
                <textarea id="bulkText" placeholder="apple;—è–±–ª–æ–∫–æ&#10;car;–º–∞—à–∏–Ω–∞"></textarea>
                <button class="btn-action" onclick="addWords()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>

        <button class="exit-btn" onclick="logout()">üö™ –í–´–•–û–î</button>
    </div>

</body>
</html>
