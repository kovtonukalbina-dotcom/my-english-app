<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro App</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            words: [
                {en: "Apple", ru: "–Ø–±–ª–æ–∫–æ", cat: "Base"}, {en: "Book", ru: "–ö–Ω–∏–≥–∞", cat: "Base"},
                {en: "Cat", ru: "–ö–æ—Ç", cat: "Base"}, {en: "Dog", ru: "–°–æ–±–∞–∫–∞", cat: "Base"},
                {en: "Home", ru: "–î–æ–º", cat: "Base"}, {en: "Work", ru: "–†–∞–±–æ—Ç–∞", cat: "Base"},
                {en: "Water", ru: "–í–æ–¥–∞", cat: "Base"}, {en: "Friend", ru: "–î—Ä—É–≥", cat: "Base"},
                {en: "School", ru: "–®–∫–æ–ª–∞", cat: "Base"}, {en: "Time", ru: "–í—Ä–µ–º—è", cat: "Base"}
            ],
            streak: 0,
            lastDate: ""
        };

        // –í—Ö–æ–¥
        window.login = async () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            try {
                await signInWithPopup(auth, provider);
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
            }
        };

        // –í—ã—Ö–æ–¥
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            const authSect = document.getElementById('authSection');
            const mainSect = document.getElementById('mainApp');
            
            if (user) {
                authSect.style.display = 'none';
                mainSect.style.display = 'block';
                await loadUserData(user.uid);
                renderFolders();
                showTab('cardsTab');
            } else {
                authSect.style.display = 'flex';
                mainSect.style.display = 'none';
            }
        });

        async function loadUserData(uid) {
            try {
                const snap = await getDoc(doc(db, "users", uid));
                if (snap.exists()) {
                    state = { ...state, ...snap.data() };
                } else {
                    await setDoc(doc(db, "users", uid), state);
                }
                updateStreakUI();
            } catch (e) {
                console.error("Cloud error, using local data");
            }
        }

        function updateStreakUI() {
            const today = new Date().toDateString();
            if (state.lastDate && state.lastDate !== today) {
                const diff = (new Date(today) - new Date(state.lastDate)) / 86400000;
                if (diff > 1) state.streak = 0;
            }
            document.getElementById('streakLabel').innerText = "üî• –°–µ—Ä–∏—è: " + state.streak;
        }

        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            if (tabId === 'cardsTab') drawCard();
        };

        function renderFolders() {
            const cats = [...new Set(state.words.map(w => w.cat))];
            const options = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('cardCat').innerHTML = options;
            document.getElementById('testCat').innerHTML = options;
        }

        // --- –ö–ê–†–¢–û–ß–ö–ò ---
        window.drawCard = () => {
            const cat = document.getElementById('cardCat').value;
            const pool = state.words.filter(w => w.cat === cat);
            const word = pool[Math.floor(Math.random() * pool.length)];
            const box = document.getElementById('cardBox');
            if(!word) return box.innerHTML = "–ù–µ—Ç —Å–ª–æ–≤";
            
            box.innerHTML = `
                <div class="card-inner" onclick="this.classList.toggle('flipped'); speak('${word.en}')">
                    <div class="card-front">${word.ru}</div>
                    <div class="card-back">${word.en}</div>
                </div>`;
        };

        window.speak = (txt) => {
            const m = new SpeechSynthesisUtterance(txt);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        };

        // --- –¢–ï–°–¢–´ ---
        let currentTest = [];
        window.startTest = () => {
            const cat = document.getElementById('testCat').value;
            const count = parseInt(document.getElementById('testCount').value) || 5;
            const types = Array.from(document.querySelectorAll('.t-type:checked')).map(i => i.value);
            
            if (!types.length) return alert("–í—ã–±–µ—Ä–∏ —Ç–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π!");
            
            const pool = state.words.filter(w => w.cat === cat);
            currentTest = [...pool].sort(() => 0.5 - Math.random()).slice(0, count).map(w => {
                const type = types[Math.floor(Math.random() * types.length)];
                let q = { word: w, type, userAns: "" };
                if (type === 'choice') {
                    q.opts = [w.en, ...pool.filter(x => x.en !== w.en).sort(() => 0.5 - Math.random()).slice(0, 2).map(x => x.en)].sort(() => 0.5 - Math.random());
                } else if (type === 'tf') {
                    q.isTrue = Math.random() > 0.5;
                    q.fake = q.isTrue ? w.en : pool[Math.floor(Math.random()*pool.length)].en;
                } else if (type === 'letters') {
                    q.scrambled = w.en.split('').sort(() => 0.5 - Math.random()).join(' ');
                }
                return q;
            });

            renderTestBody();
            document.getElementById('testConfig').style.display = 'none';
            document.getElementById('testActive').style.display = 'block';
        };

        function renderTestBody(showRes = false) {
            const cont = document.getElementById('testQuestions');
            cont.innerHTML = currentTest.map((q, i) => {
                const corr = isCorrect(q);
                let h = `<div class="q-card ${showRes ? (corr ? 'q-correct' : 'q-wrong') : ''}">`;
                if (q.type === 'choice') {
                    h += `<p>${q.word.ru}:</p><div class="grid">${q.opts.map(o => `<button class="opt-btn ${q.userAns === o ? 'active' : ''}" onclick="setAns(${i},'${o}')">${o}</button>`).join('')}</div>`;
                } else if (q.type === 'tf') {
                    h += `<p>${q.word.ru} = ${q.fake}?</p><div class="grid" style="grid-template-columns:1fr 1fr"><button class="opt-btn ${q.userAns==='t'?'active':''}" onclick="setAns(${i},'t')">–î–∞</button><button class="opt-btn ${q.userAns==='f'?'active':''}" onclick="setAns(${i},'f')">–ù–µ—Ç</button></div>`;
                } else if (q.type === 'letters') {
                    h += `<p>${q.word.ru} (${q.scrambled}):</p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${q.userAns}">`;
                } else {
                    h += `<p>–ü–µ—Ä–µ–≤–µ–¥–∏ "${q.word.ru}":</p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${q.userAns}">`;
                }
                if (showRes && !corr) h += `<div style="color:red; font-size:14px; margin-top:5px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${q.word.en}</div>`;
                return h + `</div>`;
            }).join('');
        }

        window.setAns = (i, val) => { currentTest[i].userAns = val; renderTestBody(); };

        function isCorrect(q) {
            if (q.type === 'tf') return q.userAns === (q.isTrue ? 't' : 'f');
            return q.userAns.toLowerCase().trim() === q.word.en.toLowerCase().trim();
        }

        window.finishTest = async () => {
            renderTestBody(true);
            document.getElementById('btnFin').style.display = 'none';
            document.getElementById('btnBack').style.display = 'block';
            
            const today = new Date().toDateString();
            if (state.lastDate !== today) {
                state.streak++;
                state.lastDate = today;
                updateStreakUI();
                const user = auth.currentUser;
                if (user) await updateDoc(doc(db, "users", user.uid), { streak: state.streak, lastDate: state.lastDate });
            }
        };

        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï ---
        window.saveNewWords = async () => {
            const cat = document.getElementById('newCatName').value || "General";
            const text = document.getElementById('newWordsText').value;
            text.split('\n').forEach(line => {
                const p = line.split(';');
                if (p.length === 2) state.words.push({ en: p[0].trim(), ru: p[1].trim(), cat: cat });
            });
            const user = auth.currentUser;
            if (user) await updateDoc(doc(db, "users", user.uid), { words: state.words });
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            renderFolders();
            showTab('addTab');
        };

    </script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0f0f1e; color: white; margin: 0; padding: 15px; -webkit-tap-highlight-color: transparent; }
        #authSection { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .streak-fire { font-size: 22px; color: #ff9f43; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .nav-menu button { padding: 16px; border: none; background: #341f97; color: white; border-radius: 14px; font-weight: bold; font-size: 14px; }
        
        .card-wrap { perspective: 1000px; height: 220px; margin-bottom: 20px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 20px; font-size: 26px; font-weight: bold; background: white; color: #2d3436; padding: 20px; text-align: center; box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .card-back { transform: rotateY(180deg); background: #54a0ff; color: white; }

        .q-card { background: #f1f2f6; color: #2f3542; padding: 15px; border-radius: 18px; margin-bottom: 12px; border-left: 6px solid transparent; }
        .q-correct { border-left-color: #1dd1a1; }
        .q-wrong { border-left-color: #ee5253; }
        .grid { display: grid; gap: 8px; margin-top: 10px; }
        .opt-btn { padding: 12px; border: 1px solid #dfe6e9; border-radius: 10px; background: white; cursor: pointer; font-weight: 600; }
        .opt-btn.active { background: #54a0ff; color: white; border-color: #54a0ff; }
        .inp { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ced6e0; font-size: 16px; box-sizing: border-box; }
        
        .btn-green { background: #1dd1a1; color: white; border: none; padding: 16px; border-radius: 14px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; }
        select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; background: #2f3542; color: white; border: none; }
        textarea { width: 100%; height: 100px; border-radius: 12px; padding: 10px; box-sizing: border-box; border: none; margin-top: 5px; }
        .logout { position: fixed; top: 15px; right: 15px; color: #ff6b6b; font-size: 14px; background: none; border: none; }
    </style>
</head>
<body>

    <div id="authSection">
        <h1 style="font-size: 42px; margin-bottom: 5px;">English</h1>
        <p style="opacity: 0.6; margin-bottom: 30px;">–¢–≤–æ–π –ª–∏—á–Ω—ã–π —É—á–∏—Ç–µ–ª—å</p>
        <button class="btn-green" style="width:auto; padding: 18px 40px;" onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <div id="mainApp" style="display:none;">
        <button class="logout" onclick="logout()">–í—ã–π—Ç–∏</button>
        <div id="streakLabel" class="streak-fire">üî• –°–µ—Ä–∏—è: 0</div>
        
        <div class="nav-menu">
            <button onclick="showTab('cardsTab')">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="showTab('testsTab')">–¢–µ—Å—Ç—ã</button>
            <button onclick="showTab('addTab')">–°–ª–æ–≤–∞</button>
            <button onclick="alert('–°–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div id="cardsTab" class="tab-content">
            <select id="cardCat" onchange="drawCard()"></select>
            <div class="card-wrap" id="cardBox"></div>
            <button class="btn-green" style="background:#2f3542" onclick="drawCard()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
        </div>

        <div id="testsTab" class="tab-content" style="display:none;">
            <div id="testConfig">
                <p style="margin:0 0 10px 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–∞:</p>
                <select id="testCat"></select>
                <input type="number" id="testCount" value="5" class="inp" placeholder="–ö–æ–ª-–≤–æ —Å–ª–æ–≤">
                <div style="margin: 15px 0; background: #1e1e30; padding: 15px; border-radius: 12px;">
                    <label><input type="checkbox" class="t-type" value="choice" checked> –í—ã–±–æ—Ä –∏–∑ 3-—Ö</label><br>
                    <label style="display:block; margin: 8px 0;"><input type="checkbox" class="t-type" value="tf" checked> –ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –õ–æ–∂—å</label>
                    <label style="display:block; margin: 8px 0;"><input type="checkbox" class="t-type" value="letters" checked> –°–æ–±—Ä–∞—Ç—å –∏–∑ –±—É–∫–≤</label>
                    <label><input type="checkbox" class="t-type" value="write" checked> –ù–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</label>
                </div>
                <button class="btn-green" onclick="startTest()">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
            </div>
            <div id="testActive" style="display:none;">
                <div id="testQuestions"></div>
                <button id="btnFin" class="btn-green" onclick="finishTest()">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
                <button id="btnBack" class="btn-green" style="display:none; background:#341f97" onclick="showTab('testsTab')">–ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
            </div>
        </div>

        <div id="addTab" class="tab-content" style="display:none;">
            <div style="background: #1e1e30; padding: 20px; border-radius: 20px;">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã:</label>
                <input type="text" id="newCatName" class="inp" placeholder="–ù–∞–ø—Ä: –ï–¥–∞">
                <label style="display:block; margin-top:15px;">–°–ª–æ–≤–∞ (—Å–ª–æ–≤–æ;–ø–µ—Ä–µ–≤–æ–¥):</label>
                <textarea id="newWordsText" placeholder="apple;—è–±–ª–æ–∫–æ&#10;car;–º–∞—à–∏–Ω–∞"></textarea>
                <button class="btn-green" onclick="saveNewWords()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
    </div>

</body>
</html>
