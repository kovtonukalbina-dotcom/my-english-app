<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let state = { words: [] };
        let currentWord = null;
        let examList = [];
        let examIdx = 0;

        window.speak = (text) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) state = snap.data();
                else await setDoc(doc(db, "users", user.uid), state);
                showTab('cardsTab');
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'cardsTab') drawCard();
            if (id === 'testTab') startExam();
        };

        // –ö–ê–†–¢–û–ß–ö–ò (–ù–ï –ú–ï–ù–Ø–ï–ú)
        window.drawCard = () => {
            const cardBox = document.getElementById('cardBox');
            if (!state.words?.length) {
                cardBox.innerHTML = "<p style='color:#999'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.</p>";
                return;
            }
            currentWord = state.words[Math.floor(Math.random() * state.words.length)];
            cardBox.innerHTML = `<div class="card-display" id="activeCard" data-side="ru">${currentWord.ru}</div>`;
            document.getElementById('activeCard').onclick = function() {
                if (this.getAttribute('data-side') === 'ru') {
                    this.innerText = currentWord.en;
                    this.setAttribute('data-side', 'en');
                    speak(currentWord.en);
                } else {
                    this.innerText = currentWord.ru;
                    this.setAttribute('data-side', 'ru');
                }
            };
        };

        // –≠–ö–ó–ê–ú–ï–ù (–ù–û–í–û–ï)
        window.startExam = () => {
            if (state.words.length < 3) return alert("–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 3 —Å–ª–æ–≤–∞ –¥–ª—è —ç–∫–∑–∞–º–µ–Ω–∞!");
            examList = [...state.words].sort(() => 0.5 - Math.random()).slice(0, 5).map(w => {
                const isTF = Math.random() > 0.5;
                const fake = state.words.find(x => x.en !== w.en).en;
                return {
                    w,
                    type: isTF ? 'tf' : 'choice',
                    qText: isTF ? `–í–µ—Ä–Ω–æ –ª–∏: "${w.ru}" = "${Math.random() > 0.5 ? w.en : fake}"?` : `–ö–∞–∫ –±—É–¥–µ—Ç "${w.ru}"?`,
                    correct: isTF ? (line => line.includes(w.en) ? 'yes' : 'no') : w.en,
                    options: isTF ? ['yes', 'no'] : [w.en, fake, state.words.find(x => x.en !== w.en && x.en !== fake)?.en || 'box'].sort(() => 0.5 - Math.random())
                };
            });
            examIdx = 0;
            document.getElementById('examRes').style.display = 'none';
            document.getElementById('examBox').style.display = 'block';
            renderExamQ();
        };

        function renderExamQ() {
            const q = examList[examIdx];
            let html = `<p style="font-weight:bold; margin-bottom:20px; font-size:18px;">${q.qText}</p><div class="exam-grid">`;
            q.options.forEach(opt => {
                const label = opt === 'yes' ? '‚úÖ –ü–†–ê–í–î–ê' : (opt === 'no' ? '‚ùå –õ–û–ñ–¨' : opt);
                html += `<button class="opt-btn" onclick="checkExam('${opt}')">${label}</button>`;
            });
            html += `</div>`;
            document.getElementById('examBox').innerHTML = html;
        }

        window.checkExam = (ans) => {
            const q = examList[examIdx];
            const isCorrect = (ans === 'yes' && q.qText.includes(q.w.en)) || (ans === 'no' && !q.qText.includes(q.w.en)) || (ans === q.w.en);
            
            if (q.type === 'choice' || (ans === 'yes' && isCorrect)) speak(q.w.en);
            
            examList[examIdx].userResult = isCorrect;
            if (++examIdx < examList.length) renderExamQ();
            else showExamResult();
        };

        function showExamResult() {
            document.getElementById('examBox').style.display = 'none';
            const res = document.getElementById('examRes');
            res.style.display = 'block';
            const score = examList.filter(x => x.userResult).length;
            res.innerHTML = `<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –∏–∑ 5</h3>` + 
                examList.map(x => `<div class="res-line ${x.userResult ? 'ok' : 'err'}">${x.w.ru} ‚Äî ${x.w.en} ${x.userResult ? '‚úÖ' : '‚ùå'}</div>`).join('') +
                `<button class="save-btn" onclick="startExam()" style="margin-top:20px">–ü–û–í–¢–û–†–ò–¢–¨ –¢–ï–°–¢</button>`;
        }

        window.addBulkWords = async () => {
            const area = document.getElementById('bulkInput');
            const lines = area.value.trim().split('\n');
            let added = 0;
            lines.forEach(l => {
                const p = l.split(';');
                if (p.length >= 2) { state.words.push({ en: p[0].trim(), ru: p[1].trim() }); added++; }
            });
            if (added > 0) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { words: state.words });
                area.value = ''; alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${added}`); showTab('cardsTab');
            }
        };

    </script>
    <style>
        body { background: #0f0f1e; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        .logo { font-size: 28px; font-weight: bold; margin-bottom: 30px; }
        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 400px; margin: 0 auto 30px; }
        .nav-btn { background: #3498db; color: white; border: none; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .white-bubble { background: white; color: #333; padding: 30px; border-radius: 30px; max-width: 450px; margin: 0 auto; min-height: 250px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: center; }
        .card-display { font-size: 32px; font-weight: bold; padding: 60px 20px; border: 2px solid #e0e0e0; border-radius: 20px; cursor: pointer; margin-bottom: 20px; color: #2c3e50; }
        .exam-grid { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn { background: #f8f9fa; border: 2px solid #3498db; color: #2c3e50; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .opt-btn:active { background: #e3f2fd; }
        .res-line { padding: 10px; border-radius: 8px; margin-bottom: 5px; text-align: left; font-weight: 500; }
        .ok { background: #e8f5e9; color: #2e7d32; }
        .err { background: #ffebee; color: #c62828; }
        .save-btn { background: #3498db; color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        textarea { width: 100%; height: 200px; padding: 15px; border-radius: 15px; border: 2px solid #ddd; box-sizing: border-box; font-size: 16px; outline: none; }
        #authScreen { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { background: #2ecc71; color: white; padding: 18px 50px; border-radius: 15px; font-size: 18px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="authScreen">
        <div class="logo">üöÄ English Pro</div>
        <button class="login-btn" onclick="login()">–í–û–ô–¢–ò –° GOOGLE</button>
    </div>
    <div id="mainApp" style="display:none;">
        <div class="logo">üöÄ My English App</div>
        <div class="nav-menu">
            <button class="nav-btn" onclick="showTab('cardsTab')">üìÇ –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button class="nav-btn" onclick="showTab('testTab')">üìù –≠–∫–∑–∞–º–µ–Ω</button>
            <button class="nav-btn" onclick="showTab('addTab')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="nav-btn" style="background:#e74c3c" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
        </div>
        <div class="white-bubble">
            <div id="cardsTab" class="tab-content">
                <div id="cardBox"></div>
                <button class="save-btn" style="background:#95a5a6" onclick="drawCard()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
            </div>
            <div id="testTab" class="tab-content" style="display:none;">
                <div id="examBox"></div>
                <div id="examRes" style="display:none;"></div>
            </div>
            <div id="addTab" class="tab-content" style="display:none;">
                <textarea id="bulkInput" placeholder="apple;—è–±–ª–æ–∫–æ&#10;dog;—Å–æ–±–∞–∫–∞"></textarea>
                <button class="save-btn" onclick="addBulkWords()" style="margin-top:10px">–°–û–•–†–ê–ù–ò–¢–¨ –°–ü–ò–°–û–ö</button>
            </div>
        </div>
    </div>
</body>
</html>
