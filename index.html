<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro Max</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            words: [
                {en: "Apple", ru: "–Ø–±–ª–æ–∫–æ", cat: "Base"}, {en: "House", ru: "–î–æ–º", cat: "Base"},
                {en: "Cat", ru: "–ö–æ—Ç", cat: "Base"}, {en: "Dog", ru: "–°–æ–±–∞–∫–∞", cat: "Base"},
                {en: "Sun", ru: "–°–æ–ª–Ω—Ü–µ", cat: "Base"}, {en: "Water", ru: "–í–æ–¥–∞", cat: "Base"}
            ],
            streak: 0,
            lastDate: ""
        };

        window.login = () => {
            const p = new GoogleAuthProvider();
            p.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, p);
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) state = { ...state, ...snap.data() };
                renderFolders();
                showTab('cardsTab');
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'cardsTab') drawCard();
            if (id === 'testsTab') resetTestUI();
        };

        function renderFolders() {
            const cats = [...new Set(state.words.map(w => w.cat))];
            const html = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('cardCat').innerHTML = html;
            document.getElementById('testCat').innerHTML = html;
        }

        window.speak = (t) => {
            const m = new SpeechSynthesisUtterance(t);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        };

        // --- –ö–ê–†–¢–û–ß–ö–ò ---
        window.drawCard = () => {
            const cat = document.getElementById('cardCat').value;
            const pool = state.words.filter(w => w.cat === cat);
            const word = pool[Math.floor(Math.random() * pool.length)];
            const box = document.getElementById('cardBox');
            box.innerHTML = `<div class="card-inner" onclick="this.classList.toggle('flipped'); speak('${word.en}')">
                <div class="card-front">${word.ru}</div>
                <div class="card-back">${word.en}</div>
            </div>`;
        };

        // --- –¢–ï–°–¢–´ ---
        let currentTest = [];
        let curIdx = 0;

        function resetTestUI() {
            document.getElementById('testConfig').style.display = 'block';
            document.getElementById('testActive').style.display = 'none';
            document.getElementById('testResult').style.display = 'none';
        }

        window.startTest = () => {
            const cat = document.getElementById('testCat').value;
            const count = parseInt(document.getElementById('testCount').value) || 5;
            const types = Array.from(document.querySelectorAll('.t-type:checked')).map(i => i.value);
            if (!types.length) return alert("–í—ã–±–µ—Ä–∏ —Ç–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π!");
            
            const pool = state.words.filter(w => w.cat === cat);
            currentTest = [...pool].sort(() => 0.5 - Math.random()).slice(0, count).map(w => {
                const type = types[Math.floor(Math.random() * types.length)];
                let q = { word: w, type, userAns: "", isChecked: false };
                if (type === 'choice') q.opts = [w.en, ...pool.filter(x => x.en !== w.en).sort(() => 0.5 - Math.random()).slice(0, 2).map(x => x.en)].sort(() => 0.5 - Math.random());
                if (type === 'tf') { q.isTrue = Math.random() > 0.5; q.fake = q.isTrue ? w.en : pool[Math.floor(Math.random()*pool.length)].en; }
                if (type === 'letters') q.scrambled = w.en.split('').sort(() => 0.5 - Math.random()).join(' ');
                return q;
            });

            curIdx = 0;
            renderQuestion();
            document.getElementById('testConfig').style.display = 'none';
            document.getElementById('testActive').style.display = 'block';
        };

        function renderQuestion() {
            const q = currentTest[curIdx];
            const cont = document.getElementById('qArea');
            let h = `<div class="white-window">`;
            h += `<div class="step-counter">–í–æ–ø—Ä–æ—Å ${curIdx + 1} –∏–∑ ${currentTest.length}</div>`;
            
            if (q.type === 'choice') h += `<p>${q.word.ru}:</p><div class="grid">${q.opts.map(o => `<button class="opt-btn ${q.userAns === o ? 'active' : ''}" onclick="setAns('${o}')">${o}</button>`).join('')}</div>`;
            else if (q.type === 'tf') h += `<p>${q.word.ru} = ${q.fake}?</p><div class="grid" style="grid-template-columns:1fr 1fr"><button class="opt-btn ${q.userAns==='t'?'active':''}" onclick="setAns('t')">–î–∞</button><button class="opt-btn ${q.userAns==='f'?'active':''}" onclick="setAns('f')">–ù–µ—Ç</button></div>`;
            else if (q.type === 'letters') h += `<p>${q.word.ru}: <span class="hint">${q.scrambled}</span></p><input type="text" class="inp" oninput="setAns(this.value)" value="${q.userAns}">`;
            else h += `<p>–ü–µ—Ä–µ–≤–µ–¥–∏ "${q.word.ru}":</p><input type="text" class="inp" oninput="setAns(this.value)" value="${q.userAns}">`;
            
            cont.innerHTML = h + `</div>`;
            document.getElementById('nextBtn').innerText = (curIdx === currentTest.length - 1) ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å" : "–î–∞–ª—å—à–µ ‚Üí";
        }

        window.setAns = (v) => { currentTest[curIdx].userAns = v; renderQuestion(); };

        window.nextStep = () => {
            if (curIdx < currentTest.length - 1) {
                curIdx++;
                renderQuestion();
            } else {
                showResults();
            }
        };

        async function showResults() {
            document.getElementById('testActive').style.display = 'none';
            const resArea = document.getElementById('testResult');
            resArea.style.display = 'block';
            
            let correctCount = 0;
            resArea.innerHTML = currentTest.map(q => {
                const corr = isCorrect(q);
                if (corr) correctCount++;
                return `<div class="white-window ${corr?'q-correct':'q-wrong'}">
                    <p>${q.word.ru} - <b>${q.word.en}</b></p>
                    <small>${corr ? '‚úÖ –í–µ—Ä–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞ (—Ç–≤–æ–π –æ—Ç–≤–µ—Ç: ' + (q.userAns||'–ø—É—Å—Ç–æ') + ')'}</small>
                </div>`;
            }).join('') + `<button class="btn-green" onclick="resetTestUI()">–ü—Ä–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑</button>`;
            
            // –°—Ç—Ä–∏–∫
            const today = new Date().toDateString();
            if (state.lastDate !== today) {
                state.streak++;
                state.lastDate = today;
                await updateDoc(doc(db, "users", auth.currentUser.uid), { streak: state.streak, lastDate: state.lastDate });
            }
        }

        function isCorrect(q) {
            if (q.type === 'tf') return q.userAns === (q.fake === q.word.en ? 't' : 'f');
            return q.userAns.toLowerCase().trim() === q.word.en.toLowerCase().trim();
        }

        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï ---
        window.saveNewWords = async () => {
            const cat = document.getElementById('newCatName').value || "General";
            const text = document.getElementById('newWordsText').value;
            text.split('\n').forEach(line => {
                const p = line.split(';');
                if (p.length === 2) state.words.push({ en: p[0].trim(), ru: p[1].trim(), cat: cat });
            });
            await updateDoc(doc(db, "users", auth.currentUser.uid), { words: state.words });
            alert("–ì–æ—Ç–æ–≤–æ!");
            renderFolders();
        };

    </script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #121225; color: white; margin: 0; padding: 10px; }
        #authSection { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .nav-menu button { padding: 15px; border: none; background: #3498db; color: white; border-radius: 15px; font-weight: bold; }
        
        .white-window { background: white; color: #333; padding: 25px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .step-counter { font-size: 12px; color: #999; margin-bottom: 10px; text-transform: uppercase; }
        .q-correct { border-left: 8px solid #2ecc71; }
        .q-wrong { border-left: 8px solid #e74c3c; }

        .card-wrap { perspective: 1000px; height: 250px; margin: 20px 0; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 20px; font-size: 28px; font-weight: bold; background: white; color: #333; text-align: center; }
        .card-back { transform: rotateY(180deg); color: #3498db; }

        .grid { display: grid; gap: 10px; margin-top: 15px; }
        .opt-btn { padding: 15px; border: 1px solid #ddd; border-radius: 12px; background: #f8f9fa; font-weight: 600; cursor: pointer; }
        .opt-btn.active { background: #3498db; color: white; }
        .inp { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 18px; box-sizing: border-box; }
        .hint { color: #3498db; font-weight: bold; display: block; letter-spacing: 2px; }
        
        .btn-green { background: #2ecc71; color: white; border: none; padding: 18px; border-radius: 15px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; }
        select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; }
        textarea { width: 100%; height: 100px; border-radius: 15px; padding: 10px; box-sizing: border-box; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="authSection">
        <h1>üöÄ English Pro</h1>
        <button class="btn-green" style="width:auto; padding: 15px 40px;" onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="nav-menu">
            <button onclick="showTab('cardsTab')">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="showTab('testsTab')">–¢–µ—Å—Ç—ã</button>
            <button onclick="showTab('addTab')">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>

        <div id="cardsTab" class="tab-content" style="margin-top:20px">
            <select id="cardCat" onchange="drawCard()"></select>
            <div class="card-wrap" id="cardBox"></div>
            <button class="btn-green" style="background:#2f3542" onclick="drawCard()">–î–∞–ª—å—à–µ ‚Üí</button>
        </div>

        <div id="testsTab" class="tab-content" style="display:none; margin-top:20px">
            <div id="testConfig">
                <div class="white-window">
                    <p style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞:</p>
                    <select id="testCat" style="margin-top:10px"></select>
                    <input type="number" id="testCount" value="5" class="inp" placeholder="–°–∫–æ–ª—å–∫–æ —Å–ª–æ–≤?">
                    <div style="margin-top:15px; font-size: 14px;">
                        <label><input type="checkbox" class="t-type" value="choice" checked> –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞</label><br>
                        <label><input type="checkbox" class="t-type" value="tf" checked> True/False</label><br>
                        <label><input type="checkbox" class="t-type" value="letters" checked> –°–æ–±—Ä–∞—Ç—å –∏–∑ –±—É–∫–≤</label><br>
                        <label><input type="checkbox" class="t-type" value="write" checked> –ü–∏—Å—å–º–æ</label>
                    </div>
                </div>
                <button class="btn-green" onclick="startTest()">–ù–∞—á–∞—Ç—å</button>
            </div>
            
            <div id="testActive" style="display:none;">
                <div id="qArea"></div>
                <button class="btn-green" id="nextBtn" onclick="nextStep()">–î–∞–ª—å—à–µ ‚Üí</button>
            </div>

            <div id="testResult" style="display:none;"></div>
        </div>

        <div id="addTab" class="tab-content" style="display:none; margin-top:20px">
            <div class="white-window">
                <input type="text" id="newCatName" class="inp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏">
                <textarea id="newWordsText" placeholder="apple;—è–±–ª–æ–∫–æ (—á–µ—Ä–µ–∑ ;)"></textarea>
                <button class="btn-green" onclick="saveNewWords()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

</body>
</html>
