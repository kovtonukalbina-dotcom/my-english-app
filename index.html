<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pro Max</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        let userWords = [];
        let streak = 0;
        let lastVisit = "";
        let testQuestions = [];

        const defaultWords = [
            {en: "Apple", ru: "–Ø–±–ª–æ–∫–æ", cat: "General"}, {en: "Cat", ru: "–ö–æ—Ç", cat: "General"},
            {en: "Sun", ru: "–°–æ–ª–Ω—Ü–µ", cat: "General"}, {en: "Water", ru: "–í–æ–¥–∞", cat: "General"},
            {en: "Book", ru: "–ö–Ω–∏–≥–∞", cat: "General"}, {en: "Family", ru: "–°–µ–º—å—è", cat: "General"},
            {en: "Work", ru: "–†–∞–±–æ—Ç–∞", cat: "General"}, {en: "Friend", ru: "–î—Ä—É–≥", cat: "General"},
            {en: "School", ru: "–®–∫–æ–ª–∞", cat: "General"}, {en: "Home", ru: "–î–æ–º", cat: "General"}
        ];

        window.login = async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "users", user.uid);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    userWords = data.words || defaultWords;
                    streak = data.streak || 0;
                    lastVisit = data.lastVisit || "";
                    checkStreak(user.uid);
                } else {
                    userWords = defaultWords;
                    streak = 0;
                    lastVisit = new Date().toDateString();
                    await setDoc(docRef, { words: userWords, streak, lastVisit });
                }
                document.getElementById('auth').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                renderCats();
                showTab('cards');
            } else {
                document.getElementById('auth').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        async function checkStreak(uid) {
            const today = new Date().toDateString();
            if (lastVisit !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                if (lastVisit === yesterday.toDateString()) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–∏–∫
                } else if (lastVisit !== "") {
                    streak = 0;
                }
                lastVisit = today;
                await updateDoc(doc(db, "users", uid), { streak, lastVisit });
            }
            document.getElementById('streakLabel').innerText = "üî• –°–µ—Ä–∏—è: " + streak;
        }

        window.showTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
            document.getElementById(tab).style.display = 'block';
            if (tab === 'cards') nextCard();
        };

        function renderCats() {
            const cats = [...new Set(userWords.map(w => w.cat))];
            const options = cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('cardCat').innerHTML = options;
            document.getElementById('testCat').innerHTML = options;
        }

        // --- –ö–ê–†–¢–û–ß–ö–ò ---
        window.nextCard = () => {
            const cat = document.getElementById('cardCat').value;
            const pool = userWords.filter(w => w.cat === cat);
            const word = pool[Math.floor(Math.random() * pool.length)];
            const box = document.getElementById('cardBox');
            box.innerHTML = `
                <div class="card-inner" onclick="this.classList.toggle('flipped'); speakWord('${word.en}')">
                    <div class="card-front">${word.ru}</div>
                    <div class="card-back">${word.en}</div>
                </div>`;
        };

        window.speakWord = (txt) => {
            const msg = new SpeechSynthesisUtterance(txt);
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        };

        // --- –¢–ï–°–¢–´ ---
        window.startTest = () => {
            const count = parseInt(document.getElementById('testCount').value) || 5;
            const cat = document.getElementById('testCat').value;
            const pool = userWords.filter(w => w.cat === cat);
            const types = Array.from(document.querySelectorAll('.t-type:checked')).map(i => i.value);
            
            if (types.length === 0) return alert("–í—ã–±–µ—Ä–∏ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏–π!");
            
            testQuestions = [...pool].sort(() => 0.5 - Math.random()).slice(0, count).map(w => {
                const type = types[Math.floor(Math.random() * types.length)];
                let data = { word: w, type: type, userAns: "" };
                if (type === 'choice') {
                    data.opts = [w.en, ...pool.filter(x => x.en !== w.en).sort(() => 0.5 - Math.random()).slice(0, 2).map(x => x.en)].sort(() => 0.5 - Math.random());
                } else if (type === 'tf') {
                    data.isTrue = Math.random() > 0.5;
                    data.fake = data.isTrue ? w.en : pool[Math.floor(Math.random()*pool.length)].en;
                } else if (type === 'letters') {
                    data.scrambled = w.en.split('').sort(() => 0.5 - Math.random()).join(' ');
                }
                return data;
            });

            renderQuestions();
            document.getElementById('testSet').style.display = 'none';
            document.getElementById('testRun').style.display = 'block';
        };

        function renderQuestions(results = false) {
            const cont = document.getElementById('qList');
            cont.innerHTML = testQuestions.map((q, i) => {
                const correct = isCorrect(q);
                let html = `<div class="q-box ${results ? (correct ? 'q-ok' : 'q-err') : ''}">`;
                if (q.type === 'choice') {
                    html += `<p>${q.word.ru} - —ç—Ç–æ:</p><div class="grid">${q.opts.map(o => `<button class="opt-btn ${q.userAns === o ? 'sel' : ''}" onclick="setAns(${i},'${o}')" ${results?'disabled':''}>${o}</button>`).join('')}</div>`;
                } else if (q.type === 'tf') {
                    html += `<p>${q.word.ru} = ${q.fake}?</p><div class="grid" style="grid-template-columns: 1fr 1fr;"><button class="opt-btn ${q.userAns === 't' ? 'sel' : ''}" onclick="setAns(${i},'t')">–î–∞</button><button class="opt-btn ${q.userAns === 'f' ? 'sel' : ''}" onclick="setAns(${i},'f')">–ù–µ—Ç</button></div>`;
                } else if (q.type === 'letters') {
                    html += `<p>${q.word.ru} (–±—É–∫–≤—ã: ${q.scrambled}):</p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${q.userAns}" ${results?'disabled':''}>`;
                } else {
                    html += `<p>–ü–µ—Ä–µ–≤–µ–¥–∏ "${q.word.ru}":</p><input type="text" class="inp" oninput="setAns(${i},this.value)" value="${q.userAns}" ${results?'disabled':''}>`;
                }
                if (results && !correct) html += `<div style="color:red; margin-top:5px;">–í–µ—Ä–Ω–æ: ${q.word.en}</div>`;
                return html + `</div>`;
            }).join('');
        }

        window.setAns = (i, val) => { testQuestions[i].userAns = val; if (['choice', 'tf'].includes(testQuestions[i].type)) renderQuestions(); };

        function isCorrect(q) {
            if (q.type === 'tf') return q.userAns === (q.isTrue ? 't' : 'f');
            return q.userAns.toLowerCase().trim() === q.word.en.toLowerCase().trim();
        }

        window.finishTest = async () => {
            renderQuestions(true);
            document.getElementById('btnFin').style.display = 'none';
            document.getElementById('btnRes').style.display = 'block';
            streak++;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { streak });
            document.getElementById('streakLabel').innerText = "üî• –°–µ—Ä–∏—è: " + streak;
        };

        // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï ---
        window.saveWords = async () => {
            const cat = document.getElementById('newCat').value || "General";
            const text = document.getElementById('addList').value;
            text.split('\n').forEach(line => {
                const parts = line.split(';');
                if (parts.length === 2) userWords.push({ en: parts[0].trim(), ru: parts[1].trim(), cat: cat });
            });
            await updateDoc(doc(db, "users", auth.currentUser.uid), { words: userWords });
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            renderCats();
        };

    </script>
    <style>
        body { font-family: sans-serif; background: #121225; color: white; margin: 0; padding: 15px; }
        .auth-screen { height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .streak { font-size: 20px; color: #f1c40f; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .menu button { padding: 15px; border: none; background: #3498db; color: white; border-radius: 12px; font-weight: bold; }
        .tab { display: none; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card-container { perspective: 1000px; height: 200px; margin-bottom: 20px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 24px; border-radius: 20px; background: white; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .card-back { transform: rotateY(180deg); color: #3498db; }

        .q-box { background: white; color: #333; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 5px solid transparent; }
        .q-ok { border-left-color: #2ecc71; }
        .q-err { border-left-color: #e74c3c; }
        .grid { display: grid; gap: 5px; margin-top: 10px; }
        .opt-btn { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; cursor: pointer; }
        .opt-btn.sel { background: #3498db; color: white; }
        .inp { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        
        .btn-act { background: #2ecc71; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        textarea { width: 100%; height: 100px; border-radius: 10px; padding: 10px; box-sizing: border-box; }
        .exit { position: fixed; bottom: 10px; right: 10px; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="auth" class="auth-screen">
        <h1>üöÄ English Pro</h1>
        <button class="btn-act" style="width:auto; padding: 15px 30px;" onclick="login()">–í–û–ô–¢–ò –° GOOGLE</button>
    </div>

    <div id="app" style="display:none;">
        <div id="streakLabel" class="streak">üî• –°–µ—Ä–∏—è: 0</div>
        
        <div class="menu">
            <button onclick="showTab('cards')">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="showTab('tests')">–¢–µ—Å—Ç—ã</button>
            <button onclick="showTab('add')">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="alert('–°–∫–æ—Ä–æ!')">–û–ø—Ü–∏–∏</button>
        </div>

        <div id="cards" class="tab">
            <select id="cardCat" onchange="nextCard()"></select>
            <div class="card-container" id="cardBox"></div>
            <button class="btn-act" style="background:#7f8c8d" onclick="nextCard()">–°–õ–ï–î–£–Æ–©–ï–ï ‚Üí</button>
        </div>

        <div id="tests" class="tab">
            <div id="testSet">
                <select id="testCat"></select>
                <input type="number" id="testCount" value="5" class="inp" placeholder="–ö–æ–ª-–≤–æ —Å–ª–æ–≤">
                <div style="margin: 10px 0;">
                    <label><input type="checkbox" class="t-type" value="choice" checked> –í—ã–±–æ—Ä</label><br>
                    <label><input type="checkbox" class="t-type" value="tf" checked> True/False</label><br>
                    <label><input type="checkbox" class="t-type" value="letters" checked> –ò–∑ –±—É–∫–≤</label><br>
                    <label><input type="checkbox" class="t-type" value="write" checked> –ü–∏—Å—å–º–æ</label>
                </div>
                <button class="btn-act" onclick="startTest()">–ù–ê–ß–ê–¢–¨</button>
            </div>
            <div id="testRun" style="display:none;">
                <div id="qList"></div>
                <button id="btnFin" class="btn-act" onclick="finishTest()">–ó–ê–ö–û–ù–ß–ò–¢–¨</button>
                <button id="btnRes" class="btn-act" style="display:none; background:#3498db;" onclick="showTab('tests')">–ù–û–í–´–ô –¢–ï–°–¢</button>
            </div>
        </div>

        <div id="add" class="tab">
            <input type="text" id="newCat" class="inp" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏">
            <textarea id="addList" placeholder="—Å–ª–æ–≤–æ;–ø–µ—Ä–µ–≤–æ–¥ (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)"></textarea>
            <button class="btn-act" onclick="saveWords()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>

        <button class="exit" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>

</body>
</html>
