<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let state = { words: [] };
        let currentWord = null;
        let examList = [];
        let examIdx = 0;
        let buildResult = "";
        let targetWord = "";

        window.speak = (text) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        state = docSnap.data();
                    } else {
                        setDoc(doc(db, "users", user.uid), { words: [] });
                    }
                    if (document.getElementById('cardsTab').style.display !== 'none') drawCard();
                });
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'cardsTab') drawCard();
            if (id === 'testTab') startExam();
        };

        window.drawCard = () => {
            const cardBox = document.getElementById('cardBox');
            if (!state.words || state.words.length === 0) {
                cardBox.innerHTML = "<p>–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ ‚ûï</p>";
                return;
            }
            currentWord = state.words[Math.floor(Math.random() * state.words.length)];
            cardBox.innerHTML = `<div class="card-display" id="activeCard" data-side="ru">${currentWord.ru}</div>`;
            document.getElementById('activeCard').onclick = function() {
                if (this.getAttribute('data-side') === 'ru') {
                    this.innerText = currentWord.en;
                    this.setAttribute('data-side', 'en');
                    speak(currentWord.en);
                } else {
                    this.innerText = currentWord.ru;
                    this.setAttribute('data-side', 'ru');
                }
            };
        };

        window.addBulkWords = async () => {
            const area = document.getElementById('bulkInput');
            const lines = area.value.trim().split('\n');
            let newWords = [...state.words];
            lines.forEach(l => {
                const p = l.split(';');
                if (p.length >= 2) newWords.push({ en: p[0].trim(), ru: p[1].trim() });
            });
            await setDoc(doc(db, "users", auth.currentUser.uid), { words: newWords });
            area.value = '';
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!");
            showTab('cardsTab');
        };

        // –≠–ö–ó–ê–ú–ï–ù –ò –ë–£–ö–í–´
        window.startExam = () => {
            if (state.words.length < 3) return alert("–ú–∞–ª–æ —Å–ª–æ–≤!");
            examList = [...state.words].sort(() => 0.5 - Math.random()).slice(0, 5);
            examIdx = 0;
            document.getElementById('examRes').style.display = 'none';
            document.getElementById('buildTab').style.display = 'none';
            document.getElementById('examBox').style.display = 'block';
            renderExamQ();
        };

        function renderExamQ() {
            const q = examList[examIdx];
            const fake = state.words.find(x => x.en !== q.en).en;
            const opts = [q.en, fake].sort(() => 0.5 - Math.random());
            document.getElementById('examBox').innerHTML = `
                <p>–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è: <b>${q.ru}</b>?</p>
                <div class="exam-grid">
                    ${opts.map(o => `<button class="opt-btn" onclick="checkExam('${o}')">${o}</button>`).join('')}
                </div>`;
        }

        window.checkExam = (ans) => {
            if (ans === examList[examIdx].en) speak(ans);
            if (++examIdx < examList.length) renderExamQ();
            else startBuildGame();
        };

        window.startBuildGame = () => {
            document.getElementById('examBox').style.display = 'none';
            document.getElementById('buildTab').style.display = 'block';
            examIdx = 0;
            initBuildQ();
        };

        function initBuildQ() {
            const wObj = examList[examIdx];
            targetWord = wObj.en.toLowerCase();
            buildResult = "";
            document.getElementById('buildRu').innerText = wObj.ru;
            document.getElementById('buildInputDisplay').innerText = "_ ".repeat(targetWord.length);
            const letters = targetWord.split('').sort(() => 0.5 - Math.random());
            document.getElementById('lettersArea').innerHTML = letters.map((l, i) => 
                `<button class="letter-btn" onclick="addLetter('${l}', this)">${l}</button>`).join('');
        }

        window.addLetter = (l, btn) => {
            if (l === targetWord[buildResult.length]) {
                buildResult += l;
                btn.style.visibility = 'hidden';
                document.getElementById('buildInputDisplay').innerText = buildResult.toUpperCase();
                if (buildResult === targetWord) {
                    speak(targetWord);
                    setTimeout(() => {
                        if (++examIdx < examList.length) initBuildQ();
                        else showTab('cardsTab');
                    }, 800);
                }
            }
        };

    </script>
    <style>
        body { background: #0f0f1e; color: white; font-family: sans-serif; margin: 0; padding: 10px; text-align: center; }
        .logo { font-size: 22px; font-weight: bold; margin: 15px 0; }
        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-width: 500px; margin: 0 auto 15px; }
        .nav-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; font-size: 14px; }
        .white-bubble { background: white; color: #333; padding: 20px; border-radius: 20px; max-width: 500px; margin: 0 auto; min-height: 200px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .card-display { font-size: 28px; font-weight: bold; padding: 40px 10px; border: 1px solid #eee; border-radius: 15px; color: #2c3e50; margin-bottom: 15px; }
        .opt-btn { background: white; border: 2px solid #3498db; padding: 12px; border-radius: 10px; margin-bottom: 8px; width: 100%; font-weight: bold; }
        .letter-btn { background: #f0f0f0; border: none; padding: 10px 14px; margin: 4px; border-radius: 8px; font-size: 18px; font-weight: bold; }
        .save-btn { background: #3498db; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; }
        textarea { width: 100%; height: 150px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        #authScreen { height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { background: #2ecc71; color: white; padding: 15px 40px; border-radius: 12px; border: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="authScreen">
        <div class="logo">üöÄ English Pro Sync</div>
        <button class="login-btn" onclick="login()">–í–û–ô–¢–ò –° GOOGLE</button>
    </div>
    <div id="mainApp" style="display:none;">
        <div class="logo">üöÄ My English App</div>
        <div class="nav-menu">
            <button class="nav-btn" onclick="showTab('cardsTab')">üìÇ –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button class="nav-btn" onclick="showTab('testTab')">üìù –≠–∫–∑–∞–º–µ–Ω</button>
            <button class="nav-btn" onclick="showTab('addTab')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="nav-btn" style="background:#e74c3c" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
        </div>
        <div class="white-bubble">
            <div id="cardsTab" class="tab-content">
                <div id="cardBox"></div>
                <button class="save-btn" style="background:#95a5a6" onclick="drawCard()">–î–∞–ª—å—à–µ ‚Üí</button>
            </div>
            <div id="testTab" class="tab-content" style="display:none;">
                <div id="examBox"></div>
                <div id="buildTab" style="display:none;">
                    <h4 id="buildRu"></h4>
                    <div id="buildInputDisplay" style="font-size:20px; margin-bottom:15px; letter-spacing:2px; color:#3498db; font-weight:bold;"></div>
                    <div id="lettersArea"></div>
                </div>
                <div id="examRes" style="display:none;"></div>
            </div>
            <div id="addTab" class="tab-content" style="display:none;">
                <textarea id="bulkInput" placeholder="word;–ø–µ—Ä–µ–≤–æ–¥"></textarea>
                <button class="save-btn" onclick="addBulkWords()" style="margin-top:10px">–°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
            </div>
        </div>
    </div>
</body>
</html>
