<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My English App Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let myWords = [];
        let activeTest = [];

        window.speak = (t) => {
            window.speechSynthesis.cancel();
            let m = new SpeechSynthesisUtterance(t);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        };

        window.login = () => {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            signInWithPopup(auth, provider);
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                await loadData();
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function loadData() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            myWords = docSnap.exists() ? (docSnap.data().words || []) : [];
            changeTab('cardTab');
        }

        window.changeTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'cardTab') nextCard();
        };

        window.nextCard = () => {
            const display = document.getElementById('cardDisplay');
            if(!myWords.length) { display.innerText = "–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞!"; return; }
            const word = myWords[Math.floor(Math.random()*myWords.length)];
            display.innerText = word.ru;
            display.onclick = () => { display.innerText = word.en; speak(word.en); };
        };

        window.startTest = () => {
            const limit = parseInt(document.getElementById('testLimit').value) || 5;
            if (myWords.length < 2) return alert("–î–æ–±–∞–≤—å –±–æ–ª—å—à–µ —Å–ª–æ–≤!");
            const shuffled = [...myWords].sort(() => 0.5 - Math.random()).slice(0, limit);
            activeTest = shuffled.map(word => {
                const types = ['choice', 'tf', 'write', 'letters'];
                const type = types[Math.floor(Math.random() * types.length)];
                let data = { word, type, userAns: '' };
                if(type === 'choice') {
                    let opts = [word.en];
                    while(opts.length < Math.min(4, myWords.length)) {
                        let r = myWords[Math.floor(Math.random()*myWords.length)].en;
                        if(!opts.includes(r)) opts.push(r);
                    }
                    data.options = opts.sort(() => 0.5 - Math.random());
                } else if(type === 'tf') {
                    data.isCorrectTF = Math.random() > 0.5;
                    data.fakeEn = data.isCorrectTF ? word.en : (myWords[Math.floor(Math.random()*myWords.length)].en);
                } else if(type === 'letters') {
                    data.scrambled = word.en.split('').sort(() => 0.5 - Math.random()).join(' ');
                }
                return data;
            });
            renderTest();
            document.getElementById('testSetup').style.display = 'none';
            document.getElementById('testList').style.display = 'block';
        };

        function renderTest(showResults = false) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = activeTest.map((item, idx) => {
                const isCorrect = checkItem(item);
                let html = `<div class="mini-window ${showResults ? (isCorrect ? 'correct' : 'wrong') : ''}">`;
                if(item.type === 'choice') {
                    html += `<p>–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è "<b>${item.word.ru}</b>"?</p>
                             <div class="grid">${item.options.map(o => `<button class="opt ${item.userAns === o ? 'sel' : ''}" onclick="selectAns(${idx},'${o}')" ${showResults?'disabled':''}>${o}</button>`).join('')}</div>`;
                } else if(item.type === 'tf') {
                    html += `<p>–í–µ—Ä–Ω–æ –ª–∏: <b>${item.word.ru}</b> = <b>${item.fakeEn}</b>?</p>
                             <div class="grid" style="grid-template-columns: 1fr 1fr;">
                                <button class="opt ${item.userAns === 'true' ? 'sel' : ''}" onclick="selectAns(${idx},'true')" ${showResults?'disabled':''}>–ü—Ä–∞–≤–¥–∞</button>
                                <button class="opt ${item.userAns === 'false' ? 'sel' : ''}" onclick="selectAns(${idx},'false')" ${showResults?'disabled':''}>–õ–æ–∂—å</button>
                             </div>`;
                } else if(item.type === 'write') {
                    html += `<p>–ù–∞–ø–∏—à–∏ –ø–µ—Ä–µ–≤–æ–¥ <b>${item.word.ru}</b>:</p><input type="text" class="inp" oninput="selectAns(${idx}, this.value)" value="${item.userAns}" ${showResults?'disabled':''}>`;
                } else if(item.type === 'letters') {
                    html += `<p>–°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ <b>${item.word.ru}</b>:</p><div class="hint">${item.scrambled}</div>
                             <input type="text" class="inp" oninput="selectAns(${idx}, this.value)" value="${item.userAns}" ${showResults?'disabled':''}>`;
                }
                if(showResults && !isCorrect) { html += `<div class="err">–í–µ—Ä–Ω–æ: ${item.word.en}</div>`; speak(item.word.en); }
                return html + `</div>`;
            }).join('');
        }

        function checkItem(item) {
            if(item.type === 'tf') return item.userAns === (item.fakeEn === item.word.en).toString();
            return item.userAns.toLowerCase().trim() === item.word.en.toLowerCase().trim();
        }

        window.selectAns = (idx, val) => {
            activeTest[idx].userAns = val;
            if (['choice', 'tf'].includes(activeTest[idx].type)) renderTest();
        };

        window.finishTest = () => { renderTest(true); document.getElementById('finishBtn').style.display='none'; document.getElementById('resetTestBtn').style.display='block'; };

        window.addWords = async () => {
            const text = document.getElementById('bulkText').value.trim();
            if(!text) return;
            text.split('\n').forEach(l => {
                const p = l.split(';');
                if(p.length === 2) myWords.push({en: p[0].trim(), ru: p[1].trim()});
            });
            await setDoc(doc(db, "users", currentUser.uid), {words: myWords});
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            document.getElementById('bulkText').value = "";
        };
    </script>
    <style>
        body { font-family: sans-serif; background: #121225; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 80px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-width: 500px; margin: 20px 0; }
        .menu-grid button { padding: 15px; border: none; background: #3498db; color: white; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .section { width: 95%; max-width: 600px; }
        
        /* –ú–∏–Ω–∏-–æ–∫–æ—à–∫–∏ –¥–ª—è –∑–∞–¥–∞–Ω–∏–π */
        .mini-window { background: white; color: #333; padding: 20px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .mini-window.correct { border-left: 8px solid #2ecc71; background: #f0fff4; }
        .mini-window.wrong { border-left: 8px solid #e74c3c; background: #fff5f5; }
        
        .card-box { background: white; color: #333; font-size: 28px; font-weight: bold; padding: 50px 20px; border-radius: 20px; text-align: center; cursor: pointer; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .opt { padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; cursor: pointer; font-weight: bold; }
        .opt.sel { background: #3498db; color: white; border-color: #2980b9; }
        .inp { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        .hint { color: #3498db; font-weight: bold; margin: 5px 0; letter-spacing: 2px; }
        .err { color: #e74c3c; font-weight: bold; margin-top: 10px; }
        .btn-main { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; font-size: 16px; }
        .exit-btn { position: fixed; bottom: 20px; right: 20px; background: #c0392b; color: white; border: none; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        textarea { width: 100%; padding: 10px; border-radius: 10px; border: none; margin: 10px 0; height: 100px; }
    </style>
</head>
<body>

    <div id="authSection" style="margin-top: 100px; text-align: center;">
        <h1 style="font-size: 2.5rem;">üöÄ My English App</h1>
        <button class="btn-main" style="width: auto; padding: 15px 30px;" onclick="login()">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <div id="mainApp" style="display:none; flex-direction: column; align-items: center; width: 100%;">
        <div class="menu-grid">
            <button onclick="changeTab('cardTab')">üìá –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="changeTab('testTab')">üìù –≠–∫–∑–∞–º–µ–Ω</button>
            <button onclick="changeTab('addTab')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="alert('–°–∫–æ—Ä–æ!')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="section">
            <div id="cardTab" class="section">
                <div class="card-box" id="cardDisplay">–ù–∞–∂–º–∏...</div>
                <button class="btn-main" style="background:#7f8c8d" onclick="nextCard()">–°–õ–ï–î–£–Æ–©–ï–ï ‚Üí</button>
            </div>

            <div id="testTab" class="section" style="display:none">
                <div id="testSetup" class="mini-window">
                    <h3 style="margin:0">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</h3>
                    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤:</p>
                    <input type="number" id="testLimit" value="5" class="inp">
                    <button class="btn-main" style="margin-top:15px" onclick="startTest()">–ü–û–ï–•–ê–õ–ò!</button>
                </div>
                <div id="testList" style="display:none">
                    <div id="questionsContainer"></div>
                    <button id="finishBtn" class="btn-main" onclick="finishTest()">–ü–†–û–í–ï–†–ò–¢–¨</button>
                    <button id="resetTestBtn" class="btn-main" style="background:#3498db; display:none" onclick="changeTab('testTab')">–ù–û–í–´–ô –¢–ï–°–¢</button>
                </div>
            </div>

            <div id="addTab" class="section" style="display:none">
                <div class="mini-window">
                    <h3 style="margin:0">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</h3>
                    <p style="font-size:12px">–§–æ—Ä–º–∞—Ç: apple;—è–±–ª–æ–∫–æ (—á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π)</p>
                    <textarea id="bulkText" placeholder="cat;–∫–æ—Ç"></textarea>
                    <button class="btn-main" onclick="addWords()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
            </div>
        </div>

        <button class="exit-btn" onclick="logout()">üö™ –í–´–•–û–î</button>
    </div>

</body>
</html>
