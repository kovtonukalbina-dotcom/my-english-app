<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pro Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // –¢–í–û–ô –ö–û–ù–§–ò–ì –ò–ó –°–ö–†–ò–ù–®–û–¢–ê
        const firebaseConfig = {
            apiKey: "AIzaSyB08h5m5cqOcRXNNzHhnIFLTLAjd0kk754",
            authDomain: "bebe-615c2.firebaseapp.com",
            projectId: "bebe-615c2",
            storageBucket: "bebe-615c2.firebasestorage.app",
            messagingSenderId: "913901689922",
            appId: "1:913901689922:web:e72c374ac142486e8061db",
            measurementId: "G-T34KXLZ9L7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let currentUser = null;
        let myWords = [];
        let stats = { streak: 0, lastDate: null, totalAnswers: 0, correctAnswers: 0 };

        // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---
        window.handleAuth = async (type) => {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            try {
                if (type === 'reg') await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
        };

        window.logOut = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                await loadData();
                showTab('cardTab');
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        // --- –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ ---
        async function loadData() {
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                myWords = data.words || [];
                stats = data.stats || stats;
                checkStreak();
            } else {
                await setDoc(docRef, { words: [], stats: stats });
            }
            updateUI();
        }

        async function saveData() {
            if (!currentUser) return;
            await setDoc(doc(db, "users", currentUser.uid), { words: myWords, stats: stats });
            updateUI();
        }

        function checkStreak() {
            const today = new Date().toLocaleDateString();
            if (stats.lastDate !== today) {
                if (stats.lastDate === new Date(Date.now() - 86400000).toLocaleDateString()) {
                    stats.streak++;
                } else if (stats.lastDate !== null) {
                    stats.streak = 1;
                }
                stats.lastDate = today;
                saveData();
            }
        }

        // --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
        window.showTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'cardTab') initCard();
            if(id === 'buildTab') initBuildGame();
        };

        function updateUI() {
            document.getElementById('statInfo').innerText = `üî• –°–µ—Ä–∏—è: ${stats.streak} –¥–Ω. | ‚úÖ –í–µ—Ä–Ω–æ: ${Math.round((stats.correctAnswers / (stats.totalAnswers || 1)) * 100)}%`;
            const themeSelect = document.getElementById('themeFilter');
            const themes = [...new Set(myWords.map(w => w.theme || "–û–±—â–µ–µ"))];
            themeSelect.innerHTML = '<option value="all">–í—Å–µ —Ç–µ–º—ã</option>' + themes.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        // --- –ú–∏–Ω–∏-–∏–≥—Ä–∞: –°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ ---
        let currentBuildWord = null;
        let buildAnswer = "";
        function initBuildGame() {
            if (myWords.length === 0) return;
            currentBuildWord = myWords[Math.floor(Math.random() * myWords.length)];
            buildAnswer = "";
            document.getElementById('buildQuest').innerText = currentBuildWord.ru;
            const letters = currentBuildWord.en.split('').sort(() => 0.5 - Math.random());
            document.getElementById('letterPool').innerHTML = letters.map(l => `<button class="letter-btn" onclick="addLetter('${l}', this)">${l}</button>`).join('');
            document.getElementById('buildResult').innerText = "";
        }

        window.addLetter = (l, btn) => {
            buildAnswer += l;
            document.getElementById('buildResult').innerText = buildAnswer;
            btn.style.visibility = "hidden";
            if (buildAnswer.length === currentBuildWord.en.length) {
                if (buildAnswer.toLowerCase() === currentBuildWord.en.toLowerCase()) {
                    alert("–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ");
                    stats.correctAnswers++;
                } else {
                    alert("–û—à–∏–±–∫–∞! –ë—ã–ª–æ: " + currentBuildWord.en);
                }
                stats.totalAnswers++;
                saveData();
                initBuildGame();
            }
        };

        // --- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ---
        let currentCard = null;
        function initCard() {
            if (myWords.length === 0) { document.getElementById('cardText').innerText = "–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"; return; }
            const filter = document.getElementById('themeFilter').value;
            const list = filter === 'all' ? myWords : myWords.filter(w => w.theme === filter);
            currentCard = list[Math.floor(Math.random() * list.length)];
            document.getElementById('cardText').innerText = currentCard.ru;
        }

        window.flipCard = () => {
            const text = document.getElementById('cardText');
            text.innerText = text.innerText === currentCard.ru ? currentCard.en : currentCard.ru;
        };

        window.addWord = async () => {
            const en = document.getElementById('newEn').value.trim();
            const ru = document.getElementById('newRu').value.trim();
            const theme = document.getElementById('newTheme').value.trim() || "–û–±—â–µ–µ";
            if (en && ru) {
                myWords.push({ en, ru, theme });
                await saveData();
                document.getElementById('newEn').value = "";
                document.getElementById('newRu').value = "";
                alert("–°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
            }
        };

    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: #16213e; padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .section { display: none; } .active { display: block; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #e94560; color: #fff; font-weight: bold; cursor: pointer; margin: 5px 0; }
        .card { height: 200px; display: flex; align-items: center; justify-content: center; background: #0f3460; border-radius: 15px; font-size: 24px; cursor: pointer; margin: 20px 0; }
        .letter-btn { width: 40px; height: 40px; margin: 5px; background: #0f3460; display: inline-block; }
        .stats-bar { font-size: 0.9rem; background: #0f3460; padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: center; }
        .nav { display: flex; gap: 5px; margin-bottom: 20px; }
        .nav button { font-size: 0.7rem; padding: 8px; background: #533483; }
    </style>
</head>
<body>

    <div id="authSection" class="container" style="display:none">
        <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
        <input type="email" id="authEmail" placeholder="Email">
        <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
        <button onclick="handleAuth('reg')" style="background: #533483;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div id="mainApp" style="display:none; width: 100%; max-width: 450px;">
        <div class="stats-bar" id="statInfo">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
        
        <div class="nav">
            <button onclick="showTab('cardTab')">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="showTab('buildTab')">–°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ</button>
            <button onclick="showTab('addTab')">‚ûï –°–ª–æ–≤–∞</button>
            <button onclick="logOut()" style="background:#222">–í—ã—Ö–æ–¥</button>
        </div>

        <div class="container">
            <div id="cardTab" class="section">
                <select id="themeFilter" onchange="initCard()" style="width:100%; padding: 5px; margin-bottom:10px;"></select>
                <div class="card" id="cardText" onclick="flipCard()">...</div>
                <button onclick="initCard()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
            </div>

            <div id="buildTab" class="section">
                <h3 id="buildQuest">...</h3>
                <div id="buildResult" style="font-size: 20px; color: #e94560; margin: 10px;"></div>
                <div id="letterPool"></div>
                <button onclick="initBuildGame()" style="background:#533483; margin-top:20px;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            </div>

            <div id="addTab" class="section">
                <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ</h3>
                <input type="text" id="newEn" placeholder="English">
                <input type="text" id="newRu" placeholder="–†—É—Å—Å–∫–∏–π">
                <input type="text" id="newTheme" placeholder="–¢–µ–º–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <button onclick="addWord()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
            </div>
        </div>
    </div>

</body>
</html>
