<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Exam Pro</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let myWords = [];
        let activeTest = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {word, options, userTitle, isCorrect}

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                await loadData();
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function loadData() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            myWords = docSnap.exists() ? (docSnap.data().words || []) : [];
            changeTab('cardTab');
        }

        window.changeTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'cardTab') nextCard();
        };

        // –ö–ê–†–¢–û–ß–ö–ò
        window.nextCard = () => {
            if(!myWords.length) return document.getElementById('cardDisplay').innerText = "–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞!";
            const word = myWords[Math.floor(Math.random()*myWords.length)];
            const display = document.getElementById('cardDisplay');
            display.innerText = word.ru;
            display.onclick = () => display.innerText = word.en;
        };

        // –¢–ï–°–¢ –í–°–ï–ú –°–ü–ò–°–ö–û–ú
        window.startTest = () => {
            const limit = parseInt(document.getElementById('testLimit').value) || 5;
            const shuffled = [...myWords].sort(() => 0.5 - Math.random()).slice(0, limit);
            
            activeTest = shuffled.map(word => {
                let opts = [word.en];
                while(opts.length < Math.min(4, myWords.length)) {
                    let r = myWords[Math.floor(Math.random()*myWords.length)].en;
                    if(!opts.includes(r)) opts.push(r);
                }
                return { word, options: opts.sort(() => 0.5 - Math.random()), userAns: null };
            });

            renderTest();
            document.getElementById('testSetup').style.display = 'none';
            document.getElementById('testList').style.display = 'block';
        };

        function renderTest(showResults = false) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = activeTest.map((item, idx) => `
                <div class="test-item ${showResults ? (item.userAns === item.word.en ? 'correct' : 'wrong') : ''}">
                    <p class="q-text">${idx + 1}. –ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è "<b>${item.word.ru}</b>"?</p>
                    <div class="opt-grid">
                        ${item.options.map(opt => `
                            <button class="opt-btn ${item.userAns === opt ? 'selected' : ''}" 
                                onclick="selectAns(${idx}, '${opt}')" 
                                ${showResults ? 'disabled' : ''}>
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    ${showResults && item.userAns !== item.word.en ? `<p class="correct-hint">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${item.word.en}</p>` : ''}
                </div>
            `).join('');
            
            document.getElementById('finishBtn').style.display = showResults ? 'none' : 'block';
            document.getElementById('resetTestBtn').style.display = showResults ? 'block' : 'none';
        }

        window.selectAns = (idx, val) => {
            activeTest[idx].userAns = val;
            renderTest();
        };

        window.finishTest = () => {
            if(activeTest.some(i => i.userAns === null)) {
                if(!confirm("–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ó–∞–≤–µ—Ä—à–∏—Ç—å?")) return;
            }
            renderTest(true);
        };

        window.addWords = async () => {
            const text = document.getElementById('bulkText').value.trim();
            if(!text) return;
            text.split('\n').forEach(l => {
                const p = l.split(';');
                if(p.length === 2) myWords.push({en: p[0].trim(), ru: p[1].trim()});
            });
            await setDoc(doc(db, "users", currentUser.uid), {words: myWords});
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            document.getElementById('bulkText').value = "";
        };

    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121225; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-header { font-size: 2.5rem; margin: 30px 0; font-weight: bold; }
        .menu { display: flex; gap: 10px; margin-bottom: 30px; }
        .menu button { padding: 12px 25px; border: none; background: #3498db; color: white; border-radius: 12px; cursor: pointer; font-weight: bold; }
        
        .container { background: white; color: #333; padding: 40px; border-radius: 40px; width: 90%; max-width: 900px; min-height: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
        
        /* –°—Ç–∏–ª–∏ —Ç–µ—Å—Ç–∞ —Å–ø–∏—Å–∫–æ–º */
        .test-item { border-bottom: 1px solid #eee; padding: 20px 0; text-align: left; }
        .test-item.correct { background: #eafff2; border-radius: 15px; padding: 20px; border: 2px solid #2ecc71; margin-bottom: 10px; }
        .test-item.wrong { background: #fff1f1; border-radius: 15px; padding: 20px; border: 2px solid #e74c3c; margin-bottom: 10px; }
        .q-text { font-size: 20px; margin-bottom: 15px; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { padding: 12px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-weight: bold; }
        .opt-btn.selected { background: #3498db; color: white; border-color: #2980b9; }
        .correct-hint { color: #c0392b; font-weight: bold; margin-top: 10px; }
        
        .card-box { font-size: 40px; font-weight: bold; padding: 60px; border: 4px dashed #3498db; border-radius: 30px; margin-bottom: 20px; cursor: pointer; }
        .btn-main { background: #27ae60; color: white; border: none; padding: 18px; border-radius: 15px; width: 100%; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 20px; }
        
        .exit-btn { position: fixed; bottom: 20px; right: 20px; background: #c0392b; color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        textarea, input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 2px solid #ddd; font-size: 18px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="authSection" style="margin-top: 150px;">
        <h1>üöÄ My English App</h1>
        <button class="btn-main" onclick="signInWithPopup(getAuth(), new GoogleAuthProvider())">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <div id="mainApp" style="display:none; flex-direction: column; align-items: center; width: 100%;">
        <div class="app-header">üöÄ My English App</div>
        
        <div class="menu">
            <button onclick="changeTab('cardTab')">–ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="changeTab('testTab')">–¢–µ—Å—Ç (–°–ø–∏—Å–æ–∫)</button>
            <button onclick="changeTab('addTab')">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="container">
            <div id="cardTab" class="section">
                <div class="card-box" id="cardDisplay">...</div>
                <button class="btn-main" style="background:#7f8c8d" onclick="nextCard()">–°–õ–ï–î–£–Æ–©–ï–ï ‚Üí</button>
            </div>

            <div id="testTab" class="section" style="display:none">
                <div id="testSetup">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–∞</h2>
                    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤:</p>
                    <input type="number" id="testLimit" value="5">
                    <button class="btn-main" onclick="startTest()">–ù–ê–ß–ê–¢–¨ –≠–ö–ó–ê–ú–ï–ù</button>
                </div>
                <div id="testList" style="display:none">
                    <div id="questionsContainer"></div>
                    <button id="finishBtn" class="btn-main" onclick="finishTest()">–ó–ê–í–ï–†–®–ò–¢–¨ –¢–ï–°–¢</button>
                    <button id="resetTestBtn" class="btn-main" style="background:#3498db; display:none" onclick="changeTab('testTab')">–ù–û–í–´–ô –¢–ï–°–¢</button>
                </div>
            </div>

            <div id="addTab" class="section" style="display:none">
                <h2>–ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h2>
                <textarea id="bulkText" rows="10" placeholder="word;—Å–ª–æ–≤–æ&#10;hello;–ø—Ä–∏–≤–µ—Ç"></textarea>
                <button class="btn-main" onclick="addWords()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>

        <button class="exit-btn" onclick="signOut(getAuth())">–í–´–•–û–î</button>
    </div>

</body>
</html>
