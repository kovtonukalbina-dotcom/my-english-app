<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Pro Max</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let myWords = [];
        let activeTest = [];

        window.speak = (t) => {
            window.speechSynthesis.cancel();
            let m = new SpeechSynthesisUtterance(t);
            m.lang = 'en-US';
            window.speechSynthesis.speak(m);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                await loadData();
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function loadData() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            myWords = docSnap.exists() ? (docSnap.data().words || []) : [];
            changeTab('cardTab');
        }

        window.changeTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'cardTab') nextCard();
        };

        // КАРТОЧКИ (ПОВТОРЕНИЕ)
        window.nextCard = () => {
            if(!myWords.length) return document.getElementById('cardDisplay').innerText = "Добавь слова!";
            const word = myWords[Math.floor(Math.random()*myWords.length)];
            const display = document.getElementById('cardDisplay');
            display.innerText = word.ru;
            display.onclick = () => {
                display.innerText = word.en;
                speak(word.en);
            };
        };

        // ТЕСТ (РАЗНЫЕ ТИПЫ ЗАДАНИЙ)
        window.startTest = () => {
            const limit = parseInt(document.getElementById('testLimit').value) || 5;
            const shuffled = [...myWords].sort(() => 0.5 - Math.random()).slice(0, limit);
            
            activeTest = shuffled.map(word => {
                const types = ['choice', 'tf', 'write', 'letters'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                let data = { word, type, userAns: '' };

                if(type === 'choice') {
                    let opts = [word.en];
                    while(opts.length < Math.min(4, myWords.length)) {
                        let r = myWords[Math.floor(Math.random()*myWords.length)].en;
                        if(!opts.includes(r)) opts.push(r);
                    }
                    data.options = opts.sort(() => 0.5 - Math.random());
                } else if(type === 'tf') {
                    data.isCorrectTF = Math.random() > 0.5;
                    data.fakeEn = data.isCorrectTF ? word.en : (myWords[Math.floor(Math.random()*myWords.length)].en);
                } else if(type === 'letters') {
                    data.scrambled = word.en.split('').sort(() => 0.5 - Math.random()).join(' ');
                }
                return data;
            });

            renderTest();
            document.getElementById('testSetup').style.display = 'none';
            document.getElementById('testList').style.display = 'block';
        };

        function renderTest(showResults = false) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = activeTest.map((item, idx) => {
                let html = `<div class="test-item ${showResults ? (checkItem(item) ? 'correct' : 'wrong') : ''}">`;
                
                if(item.type === 'choice') {
