<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My English App Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let myWords = [];
        let testQueue = [];
        let currentWord = null;

        // –ö—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
        window.showFeedback = (text, isError = false) => {
            const fb = document.getElementById('feedback');
            fb.innerText = text;
            fb.style.color = isError ? "#ff4d4d" : "#2ecc71";
            fb.style.opacity = "1";
            setTimeout(() => { fb.style.opacity = "0"; }, 2000);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                await loadData();
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        async function loadData() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            myWords = docSnap.exists() ? (docSnap.data().words || []) : [];
            changeTab('cardTab');
        }

        window.changeTab = (id) => {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'cardTab') nextCard();
            if(id === 'testTab') {
                document.getElementById('testSetup').style.display = 'block';
                document.getElementById('testProcess').style.display = 'none';
            }
        };

        window.nextCard = () => {
            if(!myWords.length) {
                document.getElementById('cardDisplay').innerText = "–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –≤ –º–µ–Ω—é";
                return;
            }
            currentWord = myWords[Math.floor(Math.random()*myWords.length)];
            const card = document.getElementById('cardDisplay');
            card.innerText = currentWord.ru;
            card.onclick = () => {
                card.innerText = currentWord.en;
                let m = new SpeechSynthesisUtterance(currentWord.en); m.lang = 'en-US';
                window.speechSynthesis.speak(m);
            };
        };

        window.startTestSession = () => {
            let count = parseInt(document.getElementById('testLimit').value) || 10;
            testQueue = [...myWords].sort(() => 0.5 - Math.random()).slice(0, count);
            if(!testQueue.length) return alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Å–ª–æ–≤–∞!");
            document.getElementById('testSetup').style.display = 'none';
            document.getElementById('testProcess').style.display = 'block';
            nextTestStep();
        };

        window.nextTestStep = () => {
            if(!testQueue.length) {
                showFeedback("–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! üéâ");
                setTimeout(() => changeTab('testTab'), 2000);
                return;
            }
            currentWord = testQueue.pop();
            const mode = Math.random() > 0.5 ? 'choice' : 'tf';
            
            if(mode === 'tf') {
                const randomEn = Math.random() > 0.5 ? currentWord.en : (myWords[Math.floor(Math.random()*myWords.length)].en);
                document.getElementById('testQuest').innerText = `–í–µ—Ä–Ω–æ –ª–∏: ${currentWord.ru} = ${randomEn}?`;
                document.getElementById('testOptions').innerHTML = `
                    <button class="btn-opt" onclick="checkTF(true, ${randomEn === currentWord.en})">–ü–†–ê–í–î–ê</button>
                    <button class="btn-opt" onclick="checkTF(false, ${randomEn === currentWord.en})">–õ–û–ñ–¨</button>
                `;
            } else {
                document.getElementById('testQuest').innerText = `–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è "${currentWord.ru}"?`;
                let opts = [currentWord.en];
                while(opts.length < Math.min(4, myWords.length)) {
                    let r = myWords[Math.floor(Math.random()*myWords.length)].en;
                    if(!opts.includes(r)) opts.push(r);
                }
                opts.sort(() => 0.5 - Math.random());
                document.getElementById('testOptions').innerHTML = opts.map(o => 
                    `<button class="btn-opt" onclick="checkAnswer('${o}')">${o}</button>`
                ).join('');
            }
        };

        window.checkAnswer = (val) => {
            if(val === currentWord.en) { showFeedback("–ü—Ä–∞–≤–∏–ª—å–Ω–æ! ‚ú®"); nextTestStep(); }
            else showFeedback(`–û—à–∏–±–∫–∞! –í–µ—Ä–Ω–æ: ${currentWord.en}`, true);
        };

        window.checkTF = (userVal, isCorrect) => {
            if(userVal === isCorrect) { showFeedback("–í–µ—Ä–Ω–æ! üî•"); nextTestStep(); }
            else showFeedback(`–ù–µ–≤–µ—Ä–Ω–æ!`, true);
        };

        window.addBulkWords = async () => {
            const text = document.getElementById('bulkText').value.trim();
            if(!text) return;
            text.split('\n').forEach(line => {
                const p = line.split(';');
                if(p.length === 2) myWords.push({ en: p[0].trim(), ru: p[1].trim() });
            });
            await setDoc(doc(db, "users", currentUser.uid), { words: myWords });
            showFeedback("–°–ª–æ–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω—ã!");
            document.getElementById('bulkText').value = "";
        };

    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121225; margin: 0; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .app-header { font-size: 2.5rem; font-weight: bold; margin: 30px 0; display: flex; align-items: center; gap: 15px; }
        .menu { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
        .menu button { padding: 12px 25px; border: none; background: #3498db; color: white; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .menu button:hover { background: #2980b9; transform: translateY(-2px); }
        
        /* –ì–ª–∞–≤–Ω–æ–µ –±–µ–ª–æ–µ –æ–∫–Ω–æ */
        .container { background: white; color: #333; padding: 40px; border-radius: 40px; width: 90%; max-width: 800px; min-height: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: center; position: relative; }
        
        .feedback-msg { position: absolute; top: 20px; left: 0; right: 0; font-size: 20px; font-weight: bold; opacity: 0; transition: 0.5s; pointer-events: none; }
        
        .card-box { font-size: 45px; font-weight: bold; cursor: pointer; padding: 40px; border: 4px dashed #3498db; border-radius: 30px; margin-bottom: 30px; background: #fdfdfd; }
        
        .btn-main { background: #27ae60; color: white; border: none; padding: 18px; border-radius: 15px; width: 100%; cursor: pointer; font-size: 20px; font-weight: bold; }
        .btn-opt { width: 100%; padding: 18px; margin: 8px 0; border-radius: 15px; border: 2px solid #ddd; background: #f8f9fa; cursor: pointer; font-size: 20px; font-weight: bold; transition: 0.2s; }
        .btn-opt:hover { border-color: #3498db; background: #edf7ff; }

        input, textarea { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 2px solid #ddd; font-size: 18px; box-sizing: border-box; }
        
        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥ –≤ —É–≥–ª—É */
        .exit-btn { position: fixed; bottom: 20px; right: 20px; background: #c0392b; color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="authSection" style="text-align: center; margin-top: 150px;">
        <h1 class="app-header">üöÄ My English App</h1>
        <button class="btn-main" style="width: auto; padding: 20px 40px;" onclick="signInWithPopup(getAuth(), new GoogleAuthProvider())">–í–û–ô–¢–ò –ß–ï–†–ï–ó GOOGLE</button>
    </div>

    <div id="mainApp" style="display:none; flex-direction: column; align-items: center; width: 100%;">
        <div class="app-header">üöÄ My English App</div>
        
        <div class="menu">
            <button onclick="changeTab('cardTab')">üìá –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button onclick="changeTab('testTab')">üìù –¢–µ—Å—Ç</button>
            <button onclick="changeTab('addTab')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="container">
            <div id="feedback" class="feedback-msg"></div>

            <div id="cardTab" class="section">
                <div class="card-box" id="cardDisplay">–ù–∞–∂–º–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
                <button class="btn-main" style="background:#7f8c8d" onclick="nextCard()">–°–õ–ï–î–£–Æ–©–ï–ï –°–õ–û–í–û ‚Üí</button>
            </div>

            <div id="testTab" class="section" style="display:none">
                <div id="testSetup">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–∞</h2>
                    <p>–°–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —Ö–æ—á–µ—à—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?</p>
                    <input type="number" id="testLimit" value="10" min="1" style="text-align: center; font-size: 24px;">
                    <button class="btn-main" onclick="startTestSession()">–ù–ê–ß–ê–¢–¨ –¢–ï–°–¢</button>
                </div>
                <div id="testProcess" style="display:none">
                    <h2 id="testQuest" style="margin-bottom: 25px;">...</h2>
                    <div id="testOptions"></div>
                </div>
            </div>

            <div id="addTab" class="section" style="display:none">
                <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</h2>
                <p>–§–æ—Ä–º–∞—Ç: –∞–Ω–≥–ª–∏–π—Å–∫–∏–π;—Ä—É—Å—Å–∫–∏–π (–∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</p>
                <textarea id="bulkText" rows="8" placeholder="apple;—è–±–ª–æ–∫–æ&#10;dog;—Å–æ–±–∞–∫–∞"></textarea>
                <button class="btn-main" onclick="addBulkWords()">–°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
            </div>
        </div>

        <button class="exit-btn" onclick="signOut(getAuth())">üö™ –í–´–•–û–î</button>
    </div>

</body>
</html>
