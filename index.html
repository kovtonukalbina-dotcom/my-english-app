<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My English App Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7vbQ1BQya7SWIsGByt6pLtnkX-0WG1I8",
            authDomain: "llla-f3cd0.firebaseapp.com",
            projectId: "llla-f3cd0",
            storageBucket: "llla-f3cd0.firebasestorage.app",
            messagingSenderId: "976940645729",
            appId: "1:976940645729:web:0a6a820a6a76156cf11920"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        const baseWords = [
            {en: "Apple", ru: "–Ø–±–ª–æ–∫–æ"}, {en: "House", ru: "–î–æ–º"},
            {en: "Water", ru: "–í–æ–¥–∞"}, {en: "Friend", ru: "–î—Ä—É–≥"},
            {en: "Book", ru: "–ö–Ω–∏–≥–∞"}, {en: "Time", ru: "–í—Ä–µ–º—è"},
            {en: "Family", ru: "–°–µ–º—å—è"}, {en: "School", ru: "–®–∫–æ–ª–∞"},
            {en: "Food", ru: "–ï–¥–∞"}, {en: "Work", ru: "–†–∞–±–æ—Ç–∞"}
        ];

        let state = { words: [], streak: 0 };
        let currentTest = [];
        let curIdx = 0;

        window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                
                if (snap.exists()) {
                    state = snap.data();
                    // –ï—Å–ª–∏ —Å–ª–æ–≤ –º–∞–ª–æ –∏–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–∞–∫–æ
                    if (!state.words || state.words.length < 5) {
                        state.words = [...(state.words || []), ...baseWords];
                        await updateDoc(userRef, { words: state.words });
                    }
                } else {
                    state = { words: [...baseWords], streak: 0 };
                    await setDoc(userRef, state);
                }
                showTab('cardsTab');
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'cardsTab') drawCard();
            if (id === 'testTab') resetTest();
        };

        window.drawCard = () => {
            const cardBox = document.getElementById('cardBox');
            if (!state.words || state.words.length === 0) {
                cardBox.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤...";
                return;
            }
            const w = state.words[Math.floor(Math.random() * state.words.length)];
            cardBox.innerHTML = `
                <div class="card-display" onclick="this.innerText = (this.innerText === '${w.ru}' ? '${w.en}' : '${w.ru}')">
                    ${w.ru}
                </div>`;
        };

        window.startTest = () => {
            if (state.words.length < 3) return alert("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ —Å–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞!");
            currentTest = [...state.words].sort(() => 0.5 - Math.random()).slice(0, 5).map(w => {
                const isTF = Math.random() > 0.5;
                return { 
                    w, 
                    type: isTF ? 'tf' : 'choice',
                    ans: "",
                    fake: isTF ? (Math.random() > 0.5 ? w.en : state.words.find(x => x.en !== w.en).en) : "",
                    opts: !isTF ? [w.en, ...state.words.filter(x => x.en !== w.en).sort(() => 0.5 - Math.random()).slice(0, 2).map(x => x.en)].sort(() => 0.5 - Math.random()) : []
                };
            });
            curIdx = 0;
            renderQ();
            document.getElementById('testContent').style.display = 'block';
            document.getElementById('testResult').style.display = 'none';
        };

        function renderQ() {
            const q = currentTest[curIdx];
            const area = document.getElementById('qArea');
            let html = `<p style="font-weight:bold; margin-bottom:20px;">${q.type === 'tf' ? `–í–µ—Ä–Ω–æ –ª–∏: ${q.w.ru} = ${q.fake}?` : `–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è "${q.w.ru}"?`}</p>`;
            
            if (q.type === 'tf') {
                html += `<div class="grid-btns">
                    <button class="opt-btn" onclick="setAns('t')">–ü—Ä–∞–≤–¥–∞</button>
                    <button class="opt-btn" onclick="setAns('f')">–õ–æ–∂—å</button>
                </div>`;
            } else {
                html += `<div class="grid-btns">
                    ${q.opts.map(o => `<button class="opt-btn" onclick="setAns('${o}')">${o}</button>`).join('')}
                </div>`;
            }
            area.innerHTML = html;
        }

        window.setAns = (val) => {
            currentTest[curIdx].ans = val;
            if (curIdx < currentTest.length - 1) {
                curIdx++;
                renderQ();
            } else {
                showFinalResults();
            }
        };

        function showFinalResults() {
            document.getElementById('testContent').style.display = 'none';
            const res = document.getElementById('testResult');
            res.style.display = 'block';
            res.innerHTML = currentTest.map(q => {
                const correct = q.type === 'tf' ? (q.ans === (q.fake === q.w.en ? 't' : 'f')) : (q.ans === q.w.en);
                return `<div class="res-item ${correct ? 'res-ok' : 'res-err'}">
                    ${q.w.ru} ‚Äî ${q.w.en} ${correct ? '‚úÖ' : '‚ùå'}
                </div>`;
            }).join('') + `<button class="main-btn" onclick="startTest()" style="margin-top:20px">–ù–û–í–´–ô –¢–ï–°–¢</button>`;
        }

        window.addWord = async () => {
            const en = document.getElementById('enIn').value.trim();
            const ru = document.getElementById('ruIn').value.trim();
            if (en && ru) {
                state.words.push({ en, ru });
                await updateDoc(doc(db, "users", auth.currentUser.uid), { words: state.words });
                document.getElementById('enIn').value = '';
                document.getElementById('ruIn').value = '';
                alert("–°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
                drawCard();
            }
        };

        window.resetTest = () => {
            document.getElementById('testContent').style.display = 'none';
            document.getElementById('testResult').style.display = 'none';
            startTest();
        };

    </script>
    <style>
        body { background: #1a1a2e; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; text-align: center; }
        #authScreen { height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .logo { font-size: 24px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .nav-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; margin: 0 auto 20px; }
        .nav-btn { background: #3498db; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .white-bubble { background: white; color: #333; padding: 30px; border-radius: 25px; max-width: 500px; margin: 0 auto; min-height: 250px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: center; }
        .card-display { font-size: 32px; font-weight: bold; padding: 40px; border: 2px dashed #3498db; border-radius: 15px; cursor: pointer; margin-bottom: 20px; }
        .main-btn { background: #3498db; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; }
        .login-btn { background: #2ecc71; color: white; padding: 15px 40px; border-radius: 15px; font-size: 18px; border: none; font-weight: bold; cursor: pointer; }
        .opt-btn { background: #f0f7ff; border: 2px solid #3498db; color: #333; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 5px; }
        .grid-btns { display: flex; flex-direction: column; gap: 5px; }
        .res-item { padding: 12px; border-radius: 10px; margin-bottom: 8px; text-align: left; font-weight: bold; font-size: 14px; }
        .res-ok { background: #e8f8f0; color: #2ecc71; border-left: 5px solid #2ecc71; }
        .res-err { background: #fef1f1; color: #e74c3c; border-left: 5px solid #e74c3c; }
        input { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; outline: none; }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="logo">üöÄ English Pro Sync</div>
        <button class="login-btn" onclick="login()">–í–û–ô–¢–ò –° GOOGLE</button>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="logo">üöÄ My English App</div>
        
        <div class="nav-menu">
            <button class="nav-btn" onclick="showTab('cardsTab')">üóÇÔ∏è –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button class="nav-btn" onclick="showTab('testTab')">üìù –≠–∫–∑–∞–º–µ–Ω</button>
            <button class="nav-btn" onclick="showTab('addTab')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="nav-btn" style="background: #e74c3c;" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
        </div>

        <div class="white-bubble">
            <div id="cardsTab" class="tab-content">
                <div id="cardBox"></div>
                <button class="main-btn" style="background: #7f8c8d;" onclick="drawCard()">–°–ª–µ–¥—É—é—â–µ–µ ‚Üí</button>
            </div>

            <div id="testTab" class="tab-content" style="display:none;">
                <div id="testContent">
                    <div id="qArea"></div>
                </div>
                <div id="testResult" style="display:none;"></div>
            </div>

            <div id="addTab" class="tab-content" style="display:none;">
                <input id="enIn" placeholder="English word">
                <input id="ruIn" placeholder="–ü–µ—Ä–µ–≤–æ–¥">
                <button class="main-btn" onclick="addWord()">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

</body>
</html>
